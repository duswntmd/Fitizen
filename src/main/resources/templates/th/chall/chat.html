<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" type="image/png" sizes="96x96" href="/image/favicon-96x96.png"/>
    <title>WebSocket Test Page</title>
    <link th:href="@{/css/chat/chat.css}" rel="stylesheet" />
</head>
<body>
<div id="chatContainer">
    <!-- textarea 대신 div 사용 -->
    <div id="chatBoxArea" style="border:1px solid #ccc; width:100%; height:300px; overflow-y:scroll;"></div>
    <div id="inputContainer">
        <input id="inputMsgBox" type="text" placeholder="Type a message...">
        <input id="sendButton" type="button" value="보내기" onclick="sendButton_onclick()">
        <input id="disconnectButton" type="button" value="Disconnect" onclick="disconnectButton_onclick()">
    </div>
    <label id="fileButton" for="imgInputBox">사진보내기</label>
    <input id="imgInputBox" type="file" accept="image/*">
</div>
<script type="text/javascript">
    var userId = '[[${userId}]]';
    var g_webSocket = null;

    window.onload = function() {
        var roomId = '[[${roomId}]]';
        var host = "localhost";
        g_webSocket = new WebSocket("ws://" + host +"/chat?"+"userId="+userId +"&roomId=" + roomId);

        g_webSocket.onopen = function(message) {
            addLineToChatBox("챌린지 참여 채팅방입니다.");
        };

        g_webSocket.onmessage = function(message) {
            try {
                var data = JSON.parse(message.data); // JSON 파싱

                if (data.msg) {
                    addLineToChatBox(data.msg); // 텍스트 메시지 추가
                }
                if (data.img) {
                    displayImage(data.img); // 이미지 출력
                }
            } catch (e) {
                console.error("메시지 파싱 오류:", e);
                addLineToChatBox(message.data); // JSON이 아니면 그대로 출력
            }
        };

        g_webSocket.onclose = function(message) {
            addLineToChatBox("disconnect");
        };

        g_webSocket.onerror = function(message) {
            addLineToChatBox("Error!");
        };
    }

    function addLineToChatBox(_line) {
        if (_line == null) {
            _line = "";
        }
        var chatBoxArea = document.getElementById("chatBoxArea");
        var messageDiv = document.createElement("div");
        messageDiv.textContent = _line; // 메시지 추가
        chatBoxArea.appendChild(messageDiv); // div에 추가
        chatBoxArea.scrollTop = chatBoxArea.scrollHeight;
    }

    function displayImage(base64Image) {
        var chatBoxArea = document.getElementById("chatBoxArea");
        var imgElement = document.createElement("img");
        imgElement.src = base64Image; // base64 이미지를 img 태그의 src로 설정
        imgElement.style.maxWidth = "300px"; // 최대 너비 설정 (필요에 맞게 조정 가능)
        imgElement.style.height = "auto"; // 자동으로 높이 비율 유지
        imgElement.style.marginTop = "10px"; // 이미지 위쪽에 약간의 여백 추가

        // 이미지 요소를 chatBoxArea에 추가
        chatBoxArea.appendChild(imgElement);
        chatBoxArea.scrollTop = chatBoxArea.scrollHeight;
    }

    function sendButton_onclick() {
        var inputMsgBox = document.getElementById("inputMsgBox");
        var imgInputBox = document.getElementById("imgInputBox");
        var currentTime = getCurrentFormattedTime();
        // 메시지와 이미지를 전송할 객체를 준비
        var obj = {
            sender:userId,
            msg: inputMsgBox.value || null,
            img: null,
            sentAt: currentTime
        };

        // 이미지 파일이 선택되었으면 base64로 인코딩하여 추가
        if (imgInputBox.files.length > 0) {
            var reader = new FileReader();
            reader.onload = function(event) {
                obj.img = event.target.result;
                // 메시지나 이미지 중 하나가 있으면 전송
                if (obj.msg || obj.img) {
                    g_webSocket.send(JSON.stringify(obj));
                }
            };
            reader.readAsDataURL(imgInputBox.files[0]);
        } else {
            // 이미지가 없을 경우 메시지가 있는지 확인 후 전송
            if (obj.msg) {
                g_webSocket.send(JSON.stringify(obj));
            }
        }

        inputMsgBox.value = "";
        imgInputBox.value = "";
        inputMsgBox.focus();

        return true;
    }

    function disconnectButton_onclick() {
        if (g_webSocket != null) {
            g_webSocket.close();
        }
    }

    function inputMsgBox_onkeypress(event) {
        if (event == null) {
            return false;
        }
        var keyCode = event.keyCode || event.which;
        if (keyCode == 13) {
            sendButton_onclick(event);
        }
    }
    function getCurrentFormattedTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        return `${year}.${month}.${day} ${hours}:${minutes}`;
    }

    document.getElementById('inputMsgBox').addEventListener('keypress', inputMsgBox_onkeypress);
</script>
</body>
</html>
