<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" type="image/png" sizes="96x96" href="/image/favicon-96x96.png"/>
    <title>WebSocket Test Page</title>
    <link rel="stylesheet" th:href="@{/css/index/indexStyle.css}">
    <link th:href="@{/css/challenge/chat.css}" rel="stylesheet" />
    <style>
        .page-contents {
            /*    font-family: Arial, sans-serif;*/
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            /*    height: 100vh;*/
            /*    margin: 0;*/
            min-height: 100vh;
        }
    </style>
</head>
<body>
<div>
</div>
<div class="page-contents">
    <div>
        <th:block th:replace="~{th/header :: header}"></th:block>
    </div>
<div id="chatContainer">

    <div id="chatBoxArea"></div>
    <div id="inputContainer">
        <input id="inputMsgBox" type="text" placeholder="Type a message...">
        <input id="sendButton" type="button" value="ë³´ë‚´ê¸°" onclick="sendButton_onclick()">
        <label id="fileButton" for="imgInputBox">ì‚¬ì§„ë³´ë‚´ê¸°</label>
    </div>

    <input id="imgInputBox" type="file" accept="image/*">
</div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    var userId = '[[${userId}]]';
    var g_webSocket = null;

    window.onload = function() {
        var consultId='[[${consultId}]]';
        var roomId = '[[${roomId}]]';
        var host = "localhost";
        g_webSocket = new WebSocket("ws://" + "localhost" + "/chat?" + "roomId=" + roomId +"&consultId="+consultId);

        g_webSocket.onopen = function(message) {
            addLineToChatBox("ì±Œë¦°ì§€ ì°¸ì—¬ ì±„íŒ…ë°©ì…ë‹ˆë‹¤.");
        };

        g_webSocket.onmessage = function(message) {
            try {
                var data = JSON.parse(message.data); // JSON íŒŒì‹±


                if (data.msg) {
                    addLineToChatBox(data.msg ,data.sender); // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
                }
                if (data.img) {
                    displayImage(data.img, data.fileName , data.sender); // ì´ë¯¸ì§€ ì¶œë ¥
                }
            } catch (e) {
                console.error("ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", e);
                addLineToChatBox(message.data); // JSONì´ ì•„ë‹ˆë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥
            }
        };

        g_webSocket.onclose = function(message) {
            addLineToChatBox("disconnect");
        };

        g_webSocket.onerror = function(message) {
            addLineToChatBox("Error!");
        };
    }

    function addLineToChatBox(_line, sender) {
        if (_line == null) {
            _line = "";
        }
        var chatBoxArea = document.getElementById("chatBoxArea");
        var messageDiv = document.createElement("div");
        var senderIdDiv = document.createElement("div");

        messageDiv.textContent = _line; // ë©”ì‹œì§€ ì¶”ê°€
        senderIdDiv.textContent = sender; // ë°œì‹ ì ID ì¶”ê°€

        messageDiv.className = 'message';
        senderIdDiv.className = 'sender-id';

        // ë³´ë‚¸ ì‚¬ëŒì— ë”°ë¼ í´ë˜ìŠ¤ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •
        if (sender === userId) {
            messageDiv.classList.add('sent');
            senderIdDiv.style.display = 'none'; // ìì‹ ì˜ ë©”ì‹œì§€ì—ëŠ” ë°œì‹ ì IDë¥¼ ìˆ¨ê¹€
        } else {
            messageDiv.classList.add('received');
        }

        // ë°œì‹ ì IDë¥¼ ë©”ì‹œì§€ ìœ„ì— ì¶”ê°€
        messageDiv.appendChild(senderIdDiv);

        chatBoxArea.appendChild(messageDiv); // divì— ì¶”ê°€
        chatBoxArea.scrollTop = chatBoxArea.scrollHeight;
    }

    function displayImage(base64Image, fileName, sender) {



        var chatBoxArea = document.getElementById("chatBoxArea");

        // ì´ë¯¸ì§€ì™€ ë²„íŠ¼ì„ í¬í•¨í•  ì»¨í…Œì´ë„ˆ div ìƒì„±
        var imageContainer = document.createElement("div");
        imageContainer.className = "image-container"; // ê¸°ë³¸ í´ë˜ìŠ¤ ì¶”ê°€

        var imgElement = document.createElement("img");
        imgElement.src = base64Image; // base64 ì´ë¯¸ì§€ë¥¼ img íƒœê·¸ì˜ srcë¡œ ì„¤ì •

        // ë°œì‹ ì IDë¥¼ ì¶”ê°€í•˜ëŠ” div ìƒì„±
        var senderIdDiv = document.createElement("div");
        senderIdDiv.textContent = sender;
        senderIdDiv.className = 'sender-id';


        // "ì‚¬ì§„ ì €ì¥" ë²„íŠ¼ ìƒì„±
        var saveButton = document.createElement("button");
        saveButton.textContent = "ì‚¬ì§„ ì €ì¥";
        saveButton.onclick = function() {
            downloadImage(base64Image, fileName);
        };

        // "ë”°ë´‰" ë²„íŠ¼ ìƒì„±
        var likeButton = document.createElement("button");
        likeButton.textContent = "ğŸ‘";
        likeButton.onclick = function() {
            alert("ë”°ë´‰ ë²„íŠ¼ í´ë¦­ë¨!"); // ì›í•˜ëŠ” í–‰ë™ì„ ì •ì˜
        };

        // "ì¸ì¦ê²Œì‹œíŒì— ì˜¬ë¦¬ê¸°" ë²„íŠ¼ ìƒì„±
        var uploadButton = document.createElement("button");
        uploadButton.textContent = "ì¸ì¦ê²Œì‹œíŒì— ì˜¬ë¦¬ê¸°";
        uploadButton.onclick = function() {
            uploadToBoard(base64Image, fileName);
        };

        // ì´ë¯¸ì§€ì™€ ë²„íŠ¼ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
        imageContainer.appendChild(imgElement);




        // ë³´ë‚¸ ì‚¬ëŒì— ë”°ë¼ í´ë˜ìŠ¤ ì¶”ê°€
        if (sender === userId) {
            imageContainer.classList.add('sent'); // ì˜¤ë¥¸ìª½ ì •ë ¬
            senderIdDiv.style.display = 'none'; // ìì‹ ì˜ ì´ë¯¸ì§€ì—ëŠ” ë°œì‹ ì IDë¥¼ ìˆ¨ê¹€
            imageContainer.appendChild(uploadButton);
        } else {
            imageContainer.classList.add('received'); // ì™¼ìª½ ì •ë ¬
            imageContainer.appendChild(likeButton);
            imageContainer.appendChild(saveButton);
        }

        // ë°œì‹ ì IDë¥¼ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìœ„ì— ì¶”ê°€
        imageContainer.appendChild(senderIdDiv);

        // ì»¨í…Œì´ë„ˆë¥¼ chatBoxAreaì— ì¶”ê°€
        chatBoxArea.appendChild(imageContainer);
        chatBoxArea.scrollTop = chatBoxArea.scrollHeight;
    }



    function downloadImage(base64Image, fileName) {
        var link = document.createElement("a");
        link.href = base64Image;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function uploadToBoard(base64Image, fileName) {

        var writeDate = getCurrentFormattedTime();
        var formData = new FormData();
        var roomId = '[[${roomId}]]';
        console.log(roomId);
        formData.append("base64Img", base64Image);
        formData.append("photo", fileName);
        formData.append("userId",userId);
        formData.append("writeDate",writeDate);
        formData.append("challengeId",roomId);


        if (confirm("ì¸ì¦ ê²Œì‹œë¬¼ë¡œ ì˜¬ë¦´ê±´ê°€ìš” ? \n" +
                    "ì œëª©ì€ ì„ì‹œ ì œëª©ìœ¼ë¡œ ì˜¬ë¼ê°€ìš”! \n" +
                    "ë‚˜ì¤‘ì— ìˆ˜ì •í•˜ì„¸ìš”! \n" +
                    "-FITIZEN ê´€ë¦¬ì-"))
        {
            $.ajax({
                url: '../proofShot/addChatProof',
                method: 'post',
                cache: false,
                data: formData,
                processData: false,  // FormData ê°ì²´ë¥¼ ì²˜ë¦¬í•  ë•ŒëŠ” falseë¡œ ì„¤ì •
                contentType: false, // FormData ê°ì²´ë¥¼ ì²˜ë¦¬í•  ë•ŒëŠ” falseë¡œ ì„¤ì •
                dataType: 'json',
                success: function (res) {

                    if (res.success) {
                        alert("ì¸ì¦ ê²Œì‹œíŒì— ë“±ë¡ ë˜ì—ˆì–´ìš”!")
                        //location.reload();  // ìƒˆë¡œê³ ì¹¨
                    }

                },
                error: function (xhr, status, err) {
                    alert('ì—ëŸ¬:' + err);
                }

            });
        }

    }








        function sendButton_onclick() {
        var inputMsgBox = document.getElementById("inputMsgBox");
        var imgInputBox = document.getElementById("imgInputBox");
        var currentTime = getCurrentFormattedTime();

        // ë©”ì‹œì§€ì™€ ì´ë¯¸ì§€ë¥¼ ì „ì†¡í•  ê°ì²´ë¥¼ ì¤€ë¹„
        var obj = {
            sender: userId,
            msg: inputMsgBox.value || null,
            img: null,
            sentAt: currentTime,
            fileName: imgInputBox.files.length > 0 ? imgInputBox.files[0].name : null
        };


        // ì´ë¯¸ì§€ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìœ¼ë©´ base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì¶”ê°€
        if (imgInputBox.files.length > 0) {
            var reader = new FileReader();
            reader.onload = function(event) {
                obj.img = event.target.result;

                // ë©”ì‹œì§€ë‚˜ ì´ë¯¸ì§€ ì¤‘ í•˜ë‚˜ê°€ ìˆìœ¼ë©´ ì „ì†¡
                if (obj.msg || obj.img) {
                    g_webSocket.send(JSON.stringify(obj));
                }
            };
            reader.readAsDataURL(imgInputBox.files[0]);
        } else {
            // ì´ë¯¸ì§€ê°€ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸ í›„ ì „ì†¡
            if (obj.msg) {
                g_webSocket.send(JSON.stringify(obj));
            }
        }

        inputMsgBox.value = "";
        imgInputBox.value = "";
        inputMsgBox.focus();

        return true;
    }

    function disconnectButton_onclick() {
        if (g_webSocket != null) {
            g_webSocket.close();
        }
    }

    function inputMsgBox_onkeypress(event) {
        if (event == null) {
            return false;
        }
        var keyCode = event.keyCode || event.which;
        if (keyCode == 13) {
            sendButton_onclick(event);
        }
    }

    function getCurrentFormattedTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        return `${year}.${month}.${day} ${hours}:${minutes}`;
    }

    document.getElementById('inputMsgBox').addEventListener('keypress', inputMsgBox_onkeypress);
</script>
</body>
</html>
