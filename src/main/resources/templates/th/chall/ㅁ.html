<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="icon" type="image/png" sizes="96x96" href="/image/favicon-96x96.png"/>
    <title>웹소켓 테스트 페이지</title>
    <script type="text/javascript">

        // var  obj = {};
        // obj.type = "whisper";
        // obj.sender = "userid";
        // obj.receiver = "userid";
        // obj.message = "message";
        // obj.room = "고딩방";
        //"{'key', 'value}"

        // var jsStr = JSON.stringify(obj);
        // webSocket.sendMessage(jsStr); // JSON 문자열 전송

        //var userid = '${userid}';   /* thymeleaf 라면, '[[${userid}]]';  */
        var userid = '[[${userid}]]';
        alert('userid=' + userid);

        var g_webSocket = null;
        window.onload = function() {
            //host = "192.168.0.94";   /* 배포시에 호스트 주소로 변경 */
            // host = "localhost";
            host = "220.67.113.231";
            g_webSocket = new WebSocket("ws://"+host+"/ws/chat?userid=" + userid);
            // 접속할 때 사용된 '/ws/chat' 은 설정파일에 등록된 접속 url과 일치해야 함
            // 위처럼 웹소켓에 접속시 userid를 파라미터로 전달하면 인터셉터에서 추출하여 웹소켓핸들러 안으로 전달할 수 있다

            /* 웹소켓 접속 성공시 실행 */
            g_webSocket.onopen = function(message) {
                addLineToChatBox("Server is connected.");
            };

            /* 웹소켓 서버로부터 메시지 수신시 실행 */
            g_webSocket.onmessage = function(message) {
                addLineToChatBox(message.data);
            };

            /* 웹소켓 이용자가 연결을 해제하는 경우 실행 */
            g_webSocket.onclose = function(message) {
                addLineToChatBox("Server is disconnected.");
            };

            /* 웹소켓 에러 발생시 실행 */
            g_webSocket.onerror = function(message) {
                addLineToChatBox("Error!");
            };
        }

        /* 채팅 메시지를 화면에 표시 */
        function addLineToChatBox(_line) {
            if (_line == null) {
                _line = "";
            }

            var chatBoxArea = document.getElementById("chatBoxArea");
            chatBoxArea.value += _line + "\n";
            chatBoxArea.scrollTop = chatBoxArea.scrollHeight;
        }

        /* Send 버튼 클릭하면 서버로 메시지 전송 */
        function sendButton_onclick(event) {
            var inputMsgBox = document.getElementById("inputMsgBox"); // $('#inputMsgBox').val();
            if (inputMsgBox == null || inputMsgBox.value == null || inputMsgBox.value.length == 0) {
                return false;
            }

            var chatBoxArea = document.getElementById("chatBoxArea");

            if (g_webSocket == null || g_webSocket.readyState == 3) {
                chatBoxArea.value += "Server is disconnected.\n";
                return false;
            }

            var messageType = "broadcast"; // 기본값은 브로드캐스트
            var receiver = null;

            // 메시지가 귀속말일 경우 (예: "/w james Hello")
            var messageText = inputMsgBox.value;
            if (messageText.startsWith("/w ")) {
                messageType = "whisper";
                var splitMessage = messageText.split(' ');
                if (splitMessage.length > 2) {
                    receiver = splitMessage[1];  // 두 번째 단어를 receiver로 설정
                    messageText = splitMessage.slice(2).join(' ');  // 나머지는 메시지로 사용
                } else {
                    addLineToChatBox("Incorrect whisper format. Use: /w [username] [message]");
                    return false;
                }
            }

            var messageObj = {
                type: messageType,
                sender: userid,
                receiver: receiver,
                message: messageText
            };

            // 서버로 메시지 전송
            g_webSocket.send(JSON.stringify(messageObj));
            // g_webSocket.send('['+ userid +'] ' + inputMsgBox.value);
            inputMsgBox.value = "";
            inputMsgBox.focus();

            return true;
        }

        /* Disconnect 버튼 클릭하는 경우 호출 */
        function disconnectButton_onclick() {
            if (g_webSocket != null) {
                g_webSocket.close();
            }
        }

        /* inputMsgBox 키 입력하는 경우 호출 */
        function inputMsgBox_onkeypress(event) {
            if (event == null) {
                return false;
            }

            // 엔터키 누를 경우 서버로 메시지 전송
            var keyCode = event.keyCode || event.which;
            if (keyCode == 13) {
                sendButton_onclick(event);
            }
        }
    </script>
</head>
<body>
<input id="inputMsgBox" style="width: 250px;" type="text" onkeydown="inputMsgBox_onkeypress()">
<input id="sendButton" value="Send" type="button" onclick="sendButton_onclick()">
<input id="disconnectButton" value="Disconnect" type="button" onclick="disconnectButton_onclick()">
<br/>
<textarea id="chatBoxArea" style="width: 100%;" rows="10" cols="50" readonly="readonly"></textarea>
<script>
    document.getElementById('inputMsgBox').addEventListener('keyup', inputMsgBox_onkeypress);
</script>
</body>
</html>